
<script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
        crossorigin="anonymous"></script>
<script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=40d5056e180df9ff3ab13dbcdc86d40f"></script>
<link href="https://getbootstrap.com/docs/5.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://getbootstrap.com/docs/5.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
    html, body { height: 100%; }
    main { min-height: 100vh; }
    #map { height: 100vh; min-height: 480px; }
    .scrollarea { overflow: auto; }



</style>

<body>
<!-- ê°€ë¡œ 2ë¶„í•  ë ˆì´ì•„ì›ƒ -->
<main class="d-flex flex-nowrap">
    <!-- ì™¼ìª½ íŒ¨ë„ -->
    <aside class="d-flex flex-column align-items-stretch flex-shrink-0 bg-body-tertiary border-end"
           style="width:380px;">


<!--        <div class="p-3 border-bottom">-->
<!--            <h6 class="mb-0 fw-bold text-center text-white bg-success py-2 rounded-3 shadow-sm">-->
<!--                ì„ ìƒë‹˜ ì¼ì • ê²½ë¡œìµœì í™”-->
<!--            </h6>-->
<!--        </div>-->

        <!-- ğŸ”½ ì—¬ê¸° ë¶€ë¶„ë§Œ ì‚´ì§ ìˆ˜ì •ë¨(ê´€ë¦¬ìë©”ì¸í˜ì´ì§€ ì´ë™ ë²„íŠ¼) -->
        <div class="p-3 border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold text-center text-white bg-success py-2 px-3 rounded-3 shadow-sm flex-grow-1">
                    ì„ ìƒë‹˜ ì¼ì • ê²½ë¡œìµœì í™”
                </h6>

                <a href="/admin/main" class="btn btn-sm btn-outline-success ms-2">
                    ê´€ë¦¬ì ë©”ì¸
                </a>
            </div>
        </div>
        <!-- ğŸ”¼ ì—¬ê¸°ê¹Œì§€ í—¤ë” ì˜ì—­ -->

        <div class="p-3">
            <div class="mb-3">
                <label for="teacherIdInput" class="form-label">ì„ ìƒë‹˜ ID</label>
                <input type="text" id="teacherIdInput" class="form-control" placeholder="ì„ ìƒë‹˜ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="mb-3">
                <label for="daySelect" class="form-label">ìš”ì¼ ì„ íƒ</label>
                <select id="daySelect" class="form-select">
                    <option value="ì›”ìš”ì¼">ì›”ìš”ì¼</option>
                    <option value="í™”ìš”ì¼">í™”ìš”ì¼</option>
                    <option value="ìˆ˜ìš”ì¼">ìˆ˜ìš”ì¼</option>
                    <option value="ëª©ìš”ì¼">ëª©ìš”ì¼</option>
                    <option value="ê¸ˆìš”ì¼">ê¸ˆìš”ì¼</option>
                </select>
            </div>
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-primary" onclick="searchTeacherByDay()">ê²€ìƒ‰</button>
                <button type="button" class="btn btn-dark" onclick="goVrp()">ê²½ë¡œ ìµœì í™”</button>
                <button type="button" class="btn btn-outline-success" onclick="saveSchedule()">ì¼ì • ì €ì¥</button>
                <button type="button" class="btn btn-outline-secondary" onclick="clearAllData()">ì´ˆê¸°í™”</button>
            </div>
        </div>

        <div class="px-3">
            <div class="d-flex justify-content-between text-center mb-2">
                <div>
                    <div id="totalVisit">0ê³³</div>
                    <div class="fw-light" style="font-size:.75rem">ê²½ìœ ì§€</div>
                </div>
                <div class="border-start border-2"></div>
                <div>
                    <div id="totalDistance">0km</div>
                    <div class="fw-light" style="font-size:.75rem">ì´ë™ê±°ë¦¬</div>
                </div>
                <div class="border-start border-2"></div>
                <div>
                    <div id="totalDuration">0ë¶„</div>
                    <div class="fw-light" style="font-size:.75rem">ì´ë™ì‹œê°„</div>
                </div>
                <div class="border-start border-2"></div>
                <div>
                    <div id="totalWaitTime">0ë¶„</div>
                    <div class="fw-light" style="font-size:.75rem">ìˆ˜ì—…ì‹œê°„</div>
                </div>
            </div>
            <div id="nodeList" class="list-group scrollarea" style="height: 40vh;"></div>
        </div>
    </aside>

    <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„: ì§€ë„ -->
    <div id="map" class="flex-grow-1"></div>
</main>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="spin"
     class="position-fixed top-0 start-0 w-100 h-100 d-none justify-content-center align-items-center"
     style="z-index:1000; background:rgba(0,0,0,.1);">
    <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script>
    // ì§€ë„ ìƒì„±
    var mapContainer = document.getElementById('map'),
        mapOption = {
            center: new kakao.maps.LatLng(33.450701, 126.570667),
            level: 3
        };

    var map = new kakao.maps.Map(mapContainer, mapOption);

    function spinOn() {
        $("#spin").addClass("d-flex");
    }

    function spinOff() {
        $("#spin").removeClass("d-flex");
    }

    // ì „ì—­ ë°ì´í„° ë§µ
    const NODE_MAP = {};   // ë…¸ë“œ ì •ë³´ ì €ì¥
    const MARKER_MAP = {}; // ë§ˆì»¤ ì €ì¥
    const INFO_MAP = {};   // ì¸í¬ìœˆë„ìš° ì €ì¥

    // ì „ì—­ ìƒíƒœ ë³€ìˆ˜
    let selectedTeacherId = null;   // ê²€ìƒ‰í•œ ì„ ìƒë‹˜ ID
    let optimizedRouteData = null;  // /vrp ê²°ê³¼ ë°ì´í„°
    let selectedStudentIds = [];    // í•™ìƒ ID ëª©ë¡

    var POLYLINE = null;

    function secondsToHoursMinutes(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);

        const formattedHours = hours > 0 ? `${hours.toString().padStart(2, '0')}ì‹œê°„ ` : '';
        const formattedMinutes = minutes.toString().padStart(2, '0');

        return `${formattedHours}${formattedMinutes}ë¶„`;
    }

    function drawMarker(node, bounds, labelText) {
        if (!node || !node.x || !node.y) {
            console.error("Node ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:", node);
            return;
        }

        if (!bounds || typeof bounds.extend !== "function") {
            console.error("Bounds ê°ì²´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:", bounds);
            return;
        }

        const position = new kakao.maps.LatLng(node.y, node.x);
        bounds.extend(position);

        const marker = new kakao.maps.Marker({
            position: position,
            clickable: true,
        });
        marker.setMap(map);

        // ìˆœì„œ/ì¶œë°œ í‘œì‹œìš© ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´
        if (labelText) {
            const overlayContent = `
        <div style="
            background-color: #ffebcd;
            color: #333;
            border: 2px solid red;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
            animation: bounce 1s infinite;
        ">
            ${labelText}
        </div>
        <style>
            @keyframes bounce {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-5px); }
            }
        </style>
    `;
            const customOverlay = new kakao.maps.CustomOverlay({
                content: overlayContent,
                position: position,
                xAnchor: 0.5,
                yAnchor: 2.7,
            });
            customOverlay.setMap(map);
        }

        const name = node.name || "ì´ë¦„ ì—†ìŒ";
        const phone = node.phone || "ì „í™”ë²ˆí˜¸ ì—†ìŒ";
        const address = node.address || "ì£¼ì†Œ ì—†ìŒ";

        const infowindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:5px;">${name}<br/>${phone}<br/>${address}<br/></div>`,
            removable: true,
        });

        MARKER_MAP[node.id] = marker;
        INFO_MAP[node.id] = infowindow;

        kakao.maps.event.addListener(marker, 'click', function () {
            infowindow.open(map, marker);
        });
    }

    function drawPath(pathPointList) {
        if (pathPointList.length > 0) {
            var linePath = [];
            for (var point of pathPointList) {
                linePath.push(new kakao.maps.LatLng(point.y, point.x));
            }

            POLYLINE = new kakao.maps.Polyline({
                path: linePath,
                strokeWeight: 5,
                strokeColor: 'red',
                strokeOpacity: 0.7,
                strokeStyle: 'solid'
            });
            POLYLINE.setMap(map);
        }
    }

    function panTo(nodeId) {
        clearInfoWindow();
        const node = NODE_MAP[nodeId];
        if (!node) return;

        INFO_MAP[nodeId].open(map, MARKER_MAP[nodeId]);

        var moveLatLon = new kakao.maps.LatLng(node.y, node.x);
        map.panTo(moveLatLon);
    }

    function clearInfoWindow() {
        for (const nodeId in INFO_MAP) {
            INFO_MAP[nodeId].close();
        }
    }

    function clearNode() {
        for (const nodeId in NODE_MAP) {
            if (MARKER_MAP[nodeId]) {
                MARKER_MAP[nodeId].setMap(null);
            }
            if (INFO_MAP[nodeId]) {
                INFO_MAP[nodeId].close();
            }
            delete MARKER_MAP[nodeId];
            delete INFO_MAP[nodeId];
            delete NODE_MAP[nodeId];
        }
        if (POLYLINE) {
            POLYLINE.setMap(null);
            POLYLINE = null;
        }
    }

    // ì„ ìƒë‹˜ + ìš”ì¼ë¡œ ê²€ìƒ‰
    function searchTeacherByDay() {
        const tId = $("#teacherIdInput").val();
        const day = $("#daySelect").val();

        if (!tId) {
            alert("ì„ ìƒë‹˜ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }
        if (!day) {
            alert("ìš”ì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
            return;
        }

        clearAllData();
        spinOn();

        $.ajax({
            url: '/teacherTest',
            data: { tId: tId, day: day },
            success: function (result) {
                if (result.code !== 'SUCC') {
                    alert("ë°ì´í„° ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    spinOff();
                    return;
                }

                const data = result.data || {};
                const nodeList = data.nodeList || [];
                const totalVisit = nodeList.length || 0;
                const totalDistance = (data.totalDistance / 1000).toFixed(2);
                const totalDuration = secondsToHoursMinutes(data.totalDuration || 0);

                // ì¶œë°œì§€(ì¸ì²œì‹œì²­ì—­) ì¶”ê°€
                const startNode = {
                    id: 0,
                    name: "ì¸ì²œì‹œì²­ì—­",
                    address: "ì¸ì²œ ë‚¨ë™êµ¬ ë‚¨ë™ëŒ€ë¡œ 709",
                    x: 126.7052806,
                    y: 37.4565549,
                    phone: "032-123-4567"
                };
                nodeList.unshift(startNode);

                $("#totalVisit").text(`${totalVisit}ê³³`);
                $("#totalDistance").text(`${totalDistance} km`);
                $("#totalDuration").text(`${totalDuration}`);

                selectedStudentIds = nodeList.map(node => node.sId);
                displayNodeList(nodeList);
                spinOff();

                selectedTeacherId = tId; // âœ… ì „ì—­ì— ì €ì¥
                console.log("ê²€ìƒ‰ëœ ì„ ìƒë‹˜ ID:", selectedTeacherId);
                console.log("ë…¸ë“œë¦¬ìŠ¤íŠ¸ í™•ì¸: ", nodeList);
            },
            error: function () {
                alert("ë°ì´í„° ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                spinOff();
            }
        });
    }

    function goVrp() {
        spinOn();

        const nodes = Object.values(NODE_MAP);
        console.log("NODE_MAPì—ì„œ nodesë¡œ ì €ì¥í•œ ë°ì´í„° í™•ì¸: ", nodes);

        if (!nodes || nodes.length === 0) {
            alert("ê²½ë¡œ ìµœì í™”ì— í•„ìš”í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê²€ìƒ‰ì„ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.");
            spinOff();
            return;
        }

        $.ajax({
            url: '/vrp',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(nodes),
            success: function (response) {
                if (response.code !== 'SUCC') {
                    alert("ê²½ë¡œ ìµœì í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    spinOff();
                    return;
                }

                optimizedRouteData = response.data; // âœ… ì „ì—­ì— ì €ì¥
                console.log("ìµœì í™”ëœ ê²½ë¡œ ë°ì´í„°:", optimizedRouteData);

                displayOptimizedRoute(response.data);
                spinOff();
            },
            error: function () {
                alert("ê²½ë¡œ ìµœì í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                spinOff();
            }
        });
    }

    function displayNodeList(nodeList) {
        clearNode();

        Object.keys(NODE_MAP).forEach(key => delete NODE_MAP[key]);

        if (!nodeList || nodeList.length === 0) {
            console.warn("ë…¸ë“œ ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
            $("#nodeList").html("<div>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>");
            return;
        }

        let html = '';
        const bounds = new kakao.maps.LatLngBounds();

        // ì¶œë°œì§€
        const startNode = nodeList[0];
        if (startNode && startNode.x && startNode.y) {
            NODE_MAP[startNode.id] = startNode;
            html += `
        <a class="list-group-item list-group-item-action py-3 lh-sm mt-3 border rounded-2 bg-secondary text-white">
            <div class="d-flex w-100 align-items-center justify-content-start mb-1">
                <strong class="ms-1">ì¶œë°œì§€: ${startNode.address || "ì£¼ì†Œ ì—†ìŒ"}</strong>
            </div>
            <div class="mt-3 small">
                <div class="d-flex align-items-center">
                    <span class="badge bg-light text-dark border me-2">ì´ë¦„</span>
                    ${startNode.name || "ì´ë¦„ ì—†ìŒ"}
                </div>
            </div>
        </a>`;
            drawMarker(startNode, bounds);
        }

        // ê²½ìœ ì§€
        nodeList.slice(1).forEach((node, index) => {
            if (!node || !node.address || !node.x || !node.y) {
                console.warn("ìœ íš¨í•˜ì§€ ì•Šì€ ë…¸ë“œ ë°ì´í„°:", node);
                return;
            }

            NODE_MAP[node.id] = node;
            html += `
        <a href="javascript:panTo(${node.id});"
           class="list-group-item list-group-item-action py-3 lh-sm mt-3 border rounded-2">
            <div class="d-flex w-100 align-items-center justify-content-start mb-1">
                <span class="badge text-bg-secondary">${index + 1}</span>
                <strong class="ms-1">${node.address}</strong>
            </div>
            <div class="mt-3 small">
                <div class="d-flex align-items-center">
                    <span class="badge text-bg-light border me-2">ì´ë¦„</span>
                    ${node.name || "ì´ë¦„ ì—†ìŒ"}
                </div>
            </div>
        </a>`;
            drawMarker(node, bounds);
        });

        $("#nodeList").html(html);

        if (nodeList.length > 0) {
            map.setBounds(bounds);
        }
    }

    function displayOptimizedRoute(data) {
        clearNode();
        console.log("ìµœì í™”ëœ ê²°ê³¼:", data);

        if (!data || !data.nodeList || data.nodeList.length === 0) {
            alert("ìµœì í™” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
            spinOff();
            return;
        }

        const totalDistance = data.totalDistance || 0;
        const totalDuration = data.totalDuration || 0;
        const nodeList = data.nodeList || [];
        const totalPathPointList = data.totalPathPointList || [];

        const startNode = nodeList[0];
        const remainingNodes = nodeList.slice(1);

        $("#totalVisit").text(`${remainingNodes.length} ê³³`);
        $("#totalDistance").text(`${(totalDistance / 1000).toFixed(2)} km`);
        $("#totalDuration").text(secondsToHoursMinutes(totalDuration));

        let html = '';
        const bounds = new kakao.maps.LatLngBounds();

        // ì¶œë°œì§€
        if (startNode) {
            html += `
        <a class="list-group-item list-group-item-action py-3 lh-sm mt-3 border rounded-2 bg-secondary text-white">
            <div class="d-flex w-100 align-items-center justify-content-start mb-1">
                <strong class="ms-1">ì¶œë°œì§€: ${startNode.address || "ì£¼ì†Œ ì—†ìŒ"}</strong>
            </div>
            <div class="mt-3 small">
                <div class="d-flex align-items-center">
                    <span class="badge bg-light text-dark border me-2">ì´ë¦„</span>
                    ${startNode.name || "ì´ë¦„ ì—†ìŒ"}
                </div>
            </div>
        </a>`;
            drawMarker(startNode, bounds, "ì¶œë°œ");
        }

        // ê²½ìœ ì§€
        remainingNodes.forEach((node, index) => {
            const name = node.name || "ì´ë¦„ ì—†ìŒ";
            const address = node.address || "ì£¼ì†Œ ì—†ìŒ";
            const classReq = node.phone || "í•™ìŠµ ì‹ ì²­ ë²ˆí˜¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";

            NODE_MAP[node.id] = node;

            html += `
        <a href="javascript:panTo(${node.id});"
           class="list-group-item list-group-item-action py-3 lh-sm mt-3 border rounded-2">
            <div class="d-flex w-100 align-items-center justify-content-start mb-1">
                <span class="badge text-bg-secondary">${index + 1}</span>
                <strong class="ms-1">${address}</strong>
            </div>
            <div class="mt-3 small">
                <div class="d-flex align-items-center">
                    <span class="badge text-bg-light border me-2">ì´ë¦„</span> ${name}
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge text-bg-light border me-2">í•™ìŠµì‹ ì²­ ë²ˆí˜¸</span> ${classReq}
                </div>
            </div>
        </a>`;
            drawMarker(node, bounds, index + 1);
        });

        $("#nodeList").html(html);

        if (totalPathPointList.length > 0) {
            drawPath(totalPathPointList);
        }

        if (nodeList.length > 0) {
            map.setBounds(bounds);
        }

        spinOff();
    }

    // âœ… ì¼ì • ì €ì¥
    async function saveSchedule() {
        // ğŸ”´ teacherFound ì œê±°, selectedTeacherIdë§Œ ì‚¬ìš©
        if (!selectedTeacherId) {
            alert("ì„ ìƒë‹˜ì„ ë¨¼ì € ê²€ìƒ‰í•˜ì„¸ìš”.");
            return;
        }
        if (!optimizedRouteData ||
            !Array.isArray(optimizedRouteData.nodeList) ||
            optimizedRouteData.nodeList.length <= 1) {
            alert("ìµœì í™”ëœ ê²½ë¡œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê²½ë¡œ ìµœì í™”ë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.");
            return;
        }

        const nodeList = optimizedRouteData.nodeList;

        const startTimes = ["13:00", "15:00", "17:00", "21:30"];
        const durations  = [90, 90, 90, 90];

        const topPlaces = nodeList.slice(1, 5).map((node, index) => {
            const [h, m] = startTimes[index].split(":").map(Number);
            const startDate = new Date();
            startDate.setHours(h, m, 0, 0);
            const endDate   = new Date(startDate);
            endDate.setMinutes(startDate.getMinutes() + durations[index]);

            return {
                address: node.address || "ì£¼ì†Œ ì—†ìŒ",
                sId: node.name ?? null,
                clReqId: node.phone ?? null,
                planOrder: index + 1,
                startTime: `${String(startDate.getHours()).padStart(2,"0")}:${String(startDate.getMinutes()).padStart(2,"0")}`,
                endTime:   `${String(endDate.getHours()).padStart(2,"0")}:${String(endDate.getMinutes()).padStart(2,"0")}`
            };
        });

        for (const place of topPlaces) {
            const sIdNum   = parseInt(place.sId, 10);
            const clReqNum = parseInt(place.clReqId, 10);

            if (Number.isNaN(sIdNum) || Number.isNaN(clReqNum)) {
                alert(`í•™ìƒ ID ë˜ëŠ” í•™ìŠµì‹ ì²­ IDê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ìˆœì„œ ${place.planOrder})`);
                return;
            }

            // ì›ë³¸ ì½”ë“œ --> ì €ì¥í•˜ë©´ ì„ ìƒë‹˜ ìŠ¤ì¼€ì¤„ ë°”ë¡œ ìƒì„±ë¨
            // const scheduleData = {
            //     tId: $("#teacherIdInput").val(),
            //     planDay: $("#daySelect").val(),
            //     planPlace: place.address,
            //     sId: sIdNum,
            //     clReqId: clReqNum,
            //     planStartTime: place.startTime,
            //     planEndTime: place.endTime,
            //     planOrder: place.planOrder,
            //     planStatus: "ê²€í† ì¤‘"
            // };

            // ëª…í™•í•˜ê²Œ 'ê²°ì œ ì „'ìœ¼ë¡œ ìˆ˜ì •
            const scheduleData = {
                tId: $("#teacherIdInput").val(),
                planDay: $("#daySelect").val(),
                planPlace: place.address,
                sId: sIdNum,
                clReqId: clReqNum,
                planStartTime: place.startTime,
                planEndTime: place.endTime,
                planOrder: place.planOrder,
                planStatus: "ê²°ì œ ì „"
            };


            console.log("ì €ì¥ ë°ì´í„°:", scheduleData);

            try {
                const response = await $.ajax({
                    url: `/saveSchedule?tId=${encodeURIComponent(scheduleData.tId)}&sId=${encodeURIComponent(scheduleData.sId)}&clReqId=${encodeURIComponent(scheduleData.clReqId)}`,
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(scheduleData),
                });

                if (response && response.code === "SUCC") {
                    console.log(`ì¼ì • ì €ì¥ ì„±ê³µ (ìˆœì„œ ${scheduleData.planOrder}):`, response.message);
                } else {
                    console.error(`ì¼ì • ì €ì¥ ì‹¤íŒ¨ (ìˆœì„œ ${scheduleData.planOrder}):`, response && response.message);
                    alert(`ì¼ì • ì €ì¥ ì‹¤íŒ¨ (ìˆœì„œ ${scheduleData.planOrder})`);
                    return;
                }
            } catch (error) {
                console.error("AJAX ì˜¤ë¥˜:", error);
                alert(`ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ìˆœì„œ ${scheduleData.planOrder})`);
                return;
            }
        }

        alert("ëª¨ë“  ì¼ì •ì´ ìˆœì„œëŒ€ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // ì§€ë„ ë° ë°ì´í„° ì´ˆê¸°í™” í•¨ìˆ˜
    function clearAllData() {
        Object.values(MARKER_MAP).forEach(marker => {
            //ë§ˆì»¤ ì´ˆê¸°í™”
            if (marker) {
                marker.setMap(null);
            }
        });

        // ì§€ë„ ìœ„ ì˜¤ë²„ë ˆì´ì™€ ë¼ì¸ ì´ˆê¸°í™”
        if (POLYLINE) {
            POLYLINE.setMap(null);
            POLYLINE = null;
        }

        //ë°ì´í„° ë§µ ì´ˆê¸°í™”
        Object.keys(NODE_MAP).forEach(key => delete NODE_MAP[key]);
        Object.keys(MARKER_MAP).forEach(key => delete MARKER_MAP[key]);
        Object.keys(INFO_MAP).forEach(key => delete INFO_MAP[key]);

        // ì „ì—­ ìƒíƒœë„ ì´ˆê¸°í™”
        selectedTeacherId = null;
        optimizedRouteData = null;
        selectedStudentIds = [];

        $("#nodeList").html("<div>ê²½ë¡œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>");
        $("#totalVisit").text("0ê³³");
        $("#totalDistance").text("0km");
        $("#totalDuration").text("0ë¶„");
        $("#totalWaitTime").text("0ë¶„");

        // ì§€ë„ ì¤‘ì‹¬ ì¬ì„¤ì •
        map.setCenter(new kakao.maps.LatLng(37.4388938204128, 126.675113024566));
        map.setLevel(3);
    }
</script>
</body>
