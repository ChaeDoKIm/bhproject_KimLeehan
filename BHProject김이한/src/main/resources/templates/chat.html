<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°©.í•™_í•™ìƒì±„íŒ…</title>

    <!-- WebSocket / STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- ê¸°ë³¸ CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-gothic.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Nanum Gothic', sans-serif;
            background: linear-gradient(135deg, #f0f4ff, #fdfbff);
        }

        /* ë©”ì¸ ì±„íŒ… ì¹´ë“œ */
        .container {
            max-width: 980px;
            margin: 120px auto 40px;
            padding: 20px;
            border-radius: 24px;
            background: #ffffff;
            box-shadow:
                    0 18px 40px rgba(15, 23, 42, 0.15),
                    0 1px 4px rgba(15, 23, 42, 0.08);
        }

        /* ìƒë‹¨ íƒ€ì´í‹€ */
        .chat-header-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
        }

        .chat-header-title-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header-title-left h2 {
            font-size: 1.1rem;
            margin: 0;
            font-weight: 700;
            color: #111827;
        }

        .chat-header-badge {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 999px;
            background: #e5f5ff;
            color: #1d4ed8;
            font-weight: 600;
        }

        .chat-desc {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 18px;
        }

        /* ì „ì²´ ë ˆì´ì•„ì›ƒ: ì¢Œì¸¡(í•™ìƒ/ì„ ìƒë‹˜ ì„ íƒ) + ìš°ì¸¡(ì±„íŒ…) */
        .chat-layout {
            display: grid;
            grid-template-columns: 280px minmax(0, 1fr);
            gap: 18px;
        }

        /* ì¢Œì¸¡ ì‚¬ì´ë“œë°” */
        .chat-sidebar {
            border-radius: 18px;
            background: #f9fafb;
            padding: 14px 14px 16px;
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .sidebar-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 4px;
        }

        /* í•™ìƒ ì„ íƒ ì…€ë ‰íŠ¸ ë°•ìŠ¤ */
        .student-select-wrapper {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        #sId {
            width: 100%;
            padding: 9px 11px;
            border-radius: 10px;
            border: 1px solid #d1d5db;
            background-color: #ffffff;
            font-size: 0.85rem;
            outline: none;
            transition: all 0.2s ease;
        }

        #sId:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
        }

        /* ì„ ìƒë‹˜ ëª©ë¡ ì„¹ì…˜ */
        #teacherSection {
            display: none;
            border-radius: 14px;
            background: #eef4ff;
            padding: 10px 10px 12px;
            border: 1px solid #c7d2fe;
        }

        #teacherSection h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: #1d4ed8;
            margin: 0 0 8px;
        }

        #teacherList {
            list-style: none;
            margin: 0;
            padding: 0;
            max-height: 260px;
            overflow-y: auto;
        }

        #teacherList li {
            font-size: 0.85rem;
            background-color: #ffffff;
            border-radius: 999px;
            padding: 7px 10px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            transition: all 0.15s ease;
        }

        #teacherList li span.teacher-name {
            font-weight: 600;
            color: #111827;
        }

        #teacherList li span.teacher-id {
            font-size: 0.7rem;
            color: #9ca3af;
        }

        #teacherList li:hover {
            background-color: #e0ecff;
            border-color: #93c5fd;
            transform: translateY(-1px);
        }

        /* ìš°ì¸¡ ì±„íŒ… íŒ¨ë„ */
        .chat-panel {
            border-radius: 18px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            padding: 14px;
            display: flex;
            flex-direction: column;
            min-height: 450px;
        }

        .chat-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        #chatWith {
            font-size: 0.9rem;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }

        .chat-status-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 999px;
            background: #dcfce7;
            color: #166534;
            font-weight: 600;
        }

        .chat-box {
            display: flex;
            flex-direction: column;
            background: #ffffff;
            border-radius: 14px;
            padding: 12px;
            flex: 1;
            min-height: 360px;
        }

        /* ğŸ”¹ ì‹¤ì œ ìŠ¤í¬ë¡¤ ì„¤ì •: tChatì²˜ëŸ¼ */
        #chatMessages {
            max-height: 360px;          /* í•„ìš”í•˜ë©´ ìˆ«ì ì¡°ì ˆ ê°€ëŠ¥ */
            overflow-y: auto;
            padding-right: 4px;
        }


        /* ë©”ì‹œì§€ ì˜ì—­ */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            background: #f3f4f6;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #cbd5f5;
            border-radius: 999px;
        }

        .chat-messages li {
            list-style: none;
            padding: 8px 11px;
            max-width: 70%;
            border-radius: 16px;
            font-size: 0.8rem;
            word-wrap: break-word;
            line-height: 1.45;
        }

        /* ë‚´ ë©”ì‹œì§€ */
        .chat-messages .self {
            align-self: flex-end;
            background: #2563eb;
            color: #ffffff;
            border-bottom-right-radius: 4px;
        }

        /* ìƒëŒ€ ë©”ì‹œì§€ */
        .chat-messages .other {
            align-self: flex-start;
            background: #e5e7eb;
            color: #111827;
            border-bottom-left-radius: 4px;
        }

        /* ì¸í’‹ ì˜ì—­ */
        .send-message {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-top: 10px;
        }

        .send-message input {
            flex: 1;
            padding: 10px 14px;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            font-size: 0.85rem;
            outline: none;
            background: #f9fafb;
            transition: all 0.15s ease;
        }

        .send-message input:focus {
            background: #ffffff;
            border-color: #2563eb;
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.16);
        }

        .send-message button {
            width: 40px;
            height: 40px;
            border-radius: 999px;
            border: none;
            background: #2563eb;
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .send-message button:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.3);
        }

        .send-message button i {
            font-size: 1rem;
        }

        /* ë¹ˆ ìƒíƒœ ì•ˆë‚´ */
        #chatEmptyHint {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 0.85rem;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 800px) {
            .container {
                margin-top: 90px;
                padding: 16px;
            }

            .chat-layout {
                grid-template-columns: 1fr;
            }

            .chat-sidebar {
                order: 1;
            }

            .chat-panel {
                order: 2;
                min-height: 380px;
            }
        }

        @media (max-width: 480px) {
            .chat-header-title-left h2 {
                font-size: 1rem;
            }
            .chat-desc {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>

<header>
    <nav>
        <ul>
            <li><a href="/parent/classRequest">í•™ìŠµì‹ ì²­</a></li>
            <li><a href="/signup/form">ìƒë‹´ì‹ ì²­</a></li>
            <li><a href="/bWriteForm">ë¬¸ì˜</a></li>
        </ul>
    </nav>

    <div class="logo">
        <a href="/"><img src="/File/logo_white.png" alt="ë¡œê³ "></a>
    </div>

    <div class="t-l-j">
        <div class="teacher-page">
            <a href="/teacher/Tmain">ì„ ìƒë‹˜ í˜ì´ì§€ ë°”ë¡œê°€ê¸°â†’</a>
        </div>

        <div class="auth-buttons" th:if="${session.parentLoginId eq null}">
            <a id="login">ë¡œê·¸ì¸</a>
            <a id="join">íšŒì›ê°€ì…</a>
        </div>

        <div th:if="${session.parentLoginId ne null}">
            <!-- í•„ìš”í•˜ë‹¤ë©´ ì—¬ê¸°ì— <input type="hidden" id="loginId" th:value="${session.parentLoginId}"> ì¶”ê°€ ê°€ëŠ¥ -->
            <a th:href="@{/myChildP/{pId}(pId=${session.parentLoginId})}" id="parent">ë§ˆì´ í˜ì´ì§€</a>
            <a href="/pLogout" id="logout">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>
</header>

<div class="container">

    <!-- ìƒë‹¨ ì„¤ëª… -->
    <div class="chat-header-title">
        <div class="chat-header-title-left">
            <h2>í•™ìƒ Â· ì„ ìƒë‹˜ 1:1 ì±„íŒ…</h2>
            <span class="chat-header-badge">ì‹¤ì‹œê°„ ìƒë‹´</span>
        </div>
    </div>
    <p class="chat-desc">
        ìˆ˜ì—… ì¤‘ ê¶ê¸ˆí•œ ì ì´ë‚˜ ê³¼ì œ ê´€ë ¨ ì§ˆë¬¸ì„ ì„ ìƒë‹˜ê»˜ ë°”ë¡œ ë‚¨ê²¨ ë³´ì„¸ìš”.<br>
        í•™ìƒì„ ì„ íƒí•œ ë’¤, ì—°ê²°ëœ ì„ ìƒë‹˜ì„ ê³¨ë¼ ëŒ€í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>

    <!-- ì¢Œì¸¡: í•™ìƒ/ì„ ìƒë‹˜ ì„ íƒ Â· ìš°ì¸¡: ì±„íŒ… -->
    <div class="chat-layout">

        <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
        <aside class="chat-sidebar">

            <div class="student-select-wrapper">
                <div class="sidebar-label">ë‚´ ìë…€ ì„ íƒ</div>
                <select id="sId" name="sId" onchange="loadTeachers()">
                    <option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>
                    <option th:each="student : ${studentList}"
                            th:value="${student.sId}"
                            th:text="${student.sName}">
                    </option>
                </select>
            </div>

            <div id="teacherSection" class="teacher-list" style="display: none;">
                <h3>ì—°ê²°ëœ ì„ ìƒë‹˜</h3>
                <ul id="teacherList"></ul>
            </div>

        </aside>

        <!-- ìš°ì¸¡ ì±„íŒ… íŒ¨ë„ -->
        <section class="chat-panel">
            <div class="chat-panel-header">
                <h3 id="chatWith">ì±„íŒ… ìƒëŒ€: ì—†ìŒ</h3>

                <span class="chat-status-badge" id="chatStatus">ëŒ€ê¸° ì¤‘</span>

            </div>

            <!-- ì‹¤ì œ ì±„íŒ… ë°•ìŠ¤ -->
            <div id="chatApp" style="display: none; height: 100%;">
                <div class="chat-box">
                    <ul class="chat-messages" id="chatMessages"></ul>
                    <div class="send-message">
                        <input
                                type="text"
                                id="messageInput"
                                placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                                onkeypress="handleKeyPress(event)"
                        />
                        <button onclick="sendPrivateMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ì•„ì§ ìƒëŒ€ ì„ íƒ ì•ˆ í–ˆì„ ë•Œ í‘œì‹œ -->
            <div id="chatEmptyHint">
                í•™ìƒê³¼ ì„ ìƒë‹˜ì„ ì„ íƒí•˜ë©´ ì±„íŒ…ì´ ì‹œì‘ë©ë‹ˆë‹¤.
            </div>
        </section>
    </div>
</div>

<footer class="common-footer">
    <div class="inner-footer">
        <div class="footer-wrap">
            <div class="info-cont">
                <p class="info-txt">ê³ ê°ì„¼í„° <strong>1588-9956</strong> í‰ì¼ 09:00~18:00(ê³µíœ´ì¼ ì œì™¸)</p>
                <p class="address">â€»ê³ ê°ì„¼í„°(ì½œì„¼í„°) ì´ìš© ì‹œ í†µì‹ ìš”ê¸ˆì´ ë¶€ê³¼ ë©ë‹ˆë‹¤.</p>
                <ul class="footer-menu">
                    <li style="color:deepskyblue; font-weight:bold;"><a href="/Etc/Privacy">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</a></li>
                    <li><a href="/Etc/Clause">ì„œë¹„ìŠ¤ì•½ê´€</a></li>
                    <li><a href="/Inquiry/OnlineInquiry">ê³ ê°ì„¼í„°</a></li>
                    <li><a href="/Customer/BusinessWrite">ì œíœ´ë¬¸ì˜</a></li>
                    <li><a href="/Etc/SiteMap">ì‚¬ì´íŠ¸ë§µ</a></li>
                </ul>
                <address class="address">
                    ì¸ì²œ ë¯¸ì¶”í™€êµ¬ ë§¤ì†Œí™€ë¡œ488ë²ˆê¸¸ 6-32 íƒœìŠ¹ë¹Œë”© 5ì¸µ (ì£¼)ë°©í•™
                    <span>í†µì‹ íŒë§¤ì—… ì‹ ê³  : ì œ 2025-ì¸ì²œë¯¸ì¶”í™€êµ¬-1567í˜¸</span>
                </address>
            </div>
            <div class="etc-cont">
                <div class="btn-group sns">
                    <p class="sns-title">SNS</p>
                    <a href="https://www.instagram.com" title="ìƒˆì°½ì—´ê¸°" target="_blank" class="sns-btn instar"><i
                            class="fa-brands fa-instagram"></i><span class="hide"> ì¸ìŠ¤íƒ€ê·¸ë¨</span></a>
                    <a href="https://www.youtube.com" title="ìƒˆì°½ì—´ê¸°" target="_blank" class="sns-btn instar"><i
                            class="fa-brands fa-youtube"></i><span class="hide"> ìœ íŠœë¸Œ</span></a>
                    <a href="https://section.blog.naver.com" title="ìƒˆì°½ì—´ê¸°" target="_blank" class="sns-btn instar"><i
                            class="fa-brands fa-facebook-f"></i><span class="hide"> í˜ì´ìŠ¤ë¶</span></a>
                </div>
            </div>
        </div>
        <div class="copy-cont">
            Copyright Â© Bang.Hak All Right Reserved
        </div>
    </div>
</footer>

<!-- JS ì˜ì—­ë“¤ -->

<script src="https://code.jquery.com/jquery-3.7.1.js"
        integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
        crossorigin="anonymous"></script>

<script>
    // ìŠ¬ë¼ì´ë“œ ë°°ë„ˆ ê¸°ëŠ¥ (í•´ë‹¹ ìš”ì†Œ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ìŠ¤í‚µ)
    const slides = document.querySelector('.slides');
    const slideItems = document.querySelectorAll('.slide');
    const slideCount = slideItems.length;

    let currentIndex = 0;
    let autoSlideInterval;

    if (slides && slideCount > 0) {
        const firstClone = slideItems[0].cloneNode(true);
        const lastClone = slideItems[slideCount - 1].cloneNode(true);

        slides.appendChild(firstClone);
        slides.insertBefore(lastClone, slides.firstChild);

        const updatedSlideCount = document.querySelectorAll('.slide').length;

        slides.style.width = `${updatedSlideCount * 100}%`;
        slides.style.transform = `translateX(-100%)`;

        function updateSlidePosition() {
            slides.style.transition = 'transform 0.5s ease-in-out';
            slides.style.transform = `translateX(-${(currentIndex + 1) * 100}%)`;
        }

        function resetSlidePosition() {
            slides.style.transition = 'none';
            if (currentIndex === -1) {
                currentIndex = slideCount - 1;
                slides.style.transform = `translateX(-${(currentIndex + 1) * 100}%)`;
            } else if (currentIndex === slideCount) {
                currentIndex = 0;
                slides.style.transform = `translateX(-${(currentIndex + 1) * 100}%)`;
            }
        }

        function goToNextSlide() {
            currentIndex++;
            updateSlidePosition();
            setTimeout(resetSlidePosition, 500);
        }

        function goToPrevSlide() {
            currentIndex--;
            updateSlidePosition();
            setTimeout(resetSlidePosition, 500);
        }

        const nextBtn = document.querySelector('.next');
        const prevBtn = document.querySelector('.prev');

        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                goToNextSlide();
                resetAutoSlide();
            });
        }

        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                goToPrevSlide();
                resetAutoSlide();
            });
        }

        function startAutoSlide() {
            autoSlideInterval = setInterval(goToNextSlide, 4000);
        }

        function resetAutoSlide() {
            clearInterval(autoSlideInterval);
            startAutoSlide();
        }

        startAutoSlide();
    }

    // ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜ (ìš”ì†Œ ì—†ìœ¼ë©´ ìŠ¤í‚µ)
    document.addEventListener("DOMContentLoaded", () => {
        const header = document.querySelector(".about-header");
        const aboutContents = document.querySelectorAll(".background-shape1,.about-content");
        const teacherSectionAbout = document.querySelector(".teacher");
        const teacherContent = document.querySelectorAll(".background-shape2, .about-teacher, .about-teacher-content");

        const handleScroll = () => {
            if (header) {
                const headerRect = header.getBoundingClientRect();
                if (headerRect.top < window.innerHeight - 100) {
                    header.classList.add("visible");
                }

                if (header.classList.contains("visible")) {
                    aboutContents.forEach((content) => {
                        const rect = content.getBoundingClientRect();
                        if (rect.top < window.innerHeight - 100) {
                            content.classList.add("visible");
                        }
                    });
                }
            }

            if (teacherSectionAbout) {
                const teacherRect = teacherSectionAbout.getBoundingClientRect();
                if (teacherRect.top < window.innerHeight - 100) {
                    teacherContent.forEach((content) => {
                        content.classList.add("visible");
                    });
                }
            }
        };

        window.addEventListener("scroll", handleScroll);
        handleScroll();
    });

    // ë¡œê·¸ì¸ / ë¡œê·¸ì•„ì›ƒ / ì´ë™
    $('#logout').click(() => {
        location.href = '/pLogout';
    });

    $('#join').click(() => {
        location.href = '/pJoinForm';
    });

    $('#login').click(() => {
        location.href = '/pLoginForm';
    });

    $('#write').click(() => {
        location.href = "/bWriteForm";
    });

    $('#list').click(() => {
        location.href = "/bList";
    });

    $('#resumeList').click(() => {
        location.href = "/resume/list";
    });
</script>

<script>
    let stompClient = null;
    let userData = {
        username: '', // í•™ìƒ ID(sId)
        connected: false,
    };
    let currentPrivateChat = ''; // í˜„ì¬ ì„ íƒëœ ì„ ìƒë‹˜ tId

    // í˜ì´ì§€ ë¡œë“œ í›„ username ì„¸íŒ…
    window.onload = function () {
        const loginElement = document.getElementById('loginId'); // ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê²½ê³ ë§Œ
        if (loginElement) {
            userData.username = loginElement.value || '';
        } else {
            console.warn("[ê²½ê³ ] ë¡œê·¸ì¸ ID ìš”ì†Œ(#loginId)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ. í•™ìƒ ì„ íƒ ì‹œ sIdë¥¼ usernameìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.");
        }

        if (userData.username) {
            connect();
        }
    };

    function connect() {
        if (stompClient !== null && stompClient.connected) {
            console.log("[WebSocket] ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŒ.");
            return;
        }

        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            console.log("[WebSocket] ì—°ê²° ì„±ê³µ");

            if (!stompClient.alreadySubscribed && userData.username) {
                // ğŸ”¹ ì‹¤ì‹œê°„ ì±„íŒ… ë©”ì‹œì§€ êµ¬ë…
                stompClient.subscribe(
                    `/user/${userData.username}/private-message`,
                    onPrivateMessage
                );

                // ğŸ”¹ íƒ€ì´í•‘ ìƒíƒœ êµ¬ë…
                stompClient.subscribe(
                    `/user/${userData.username}/typing`,
                    onTypingEvent
                );

                stompClient.alreadySubscribed = true;
                console.log("[WebSocket] êµ¬ë… ì™„ë£Œ");
            }
        }, function (error) {
            console.error("[WebSocket ì˜¤ë¥˜] ì—°ê²° ì‹¤íŒ¨:", error);
            setTimeout(connect, 3000);
        });
    }


    // Enter í‚¤ë¡œ ì „ì†¡
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendPrivateMessage();
            event.preventDefault();
        }
    }

    // í•™ìƒ ì„ íƒ í›„ ì„ ìƒë‹˜ ëª©ë¡ ë¡œë“œ
    function loadTeachers() {
        const studentSelect = document.getElementById('sId');
        const sId = studentSelect.value;

        if (!sId) {
            alert("í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.");
            return;
        }

        // ì„ íƒí•œ í•™ìƒ IDë¥¼ usernameìœ¼ë¡œ ì‚¬ìš©
        userData.username = sId;
        console.log("ì„ íƒëœ í•™ìƒ ID (username):", userData.username);

        if (!stompClient || !stompClient.connected) {
            connect();
        }

        fetch(`/chat/api/getTeachersByStudent/${sId}`)
            .then(response => response.json())
            .then(teacherList => {
                const teacherListElement = document.getElementById('teacherList');
                teacherListElement.innerHTML = '';

                teacherList.forEach(teacher => {
                    const li = document.createElement('li');

                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'teacher-name';
                    nameSpan.textContent = teacher.tName;

                    const idSpan = document.createElement('span');
                    idSpan.className = 'teacher-id';
                    idSpan.textContent = `ID: ${teacher.tId}`;

                    li.appendChild(nameSpan);
                    li.appendChild(idSpan);

                    li.onclick = () => openChatRoom(teacher.tId, teacher.tName);
                    teacherListElement.appendChild(li);
                });

                document.getElementById('teacherSection').style.display = 'block';
            })
            .catch(error => console.error("Error fetching teachers:", error));
    }

    // ì±„íŒ…ë°© ì—´ê¸°
    function openChatRoom(tId, tName) {
        currentPrivateChat = tId;
        document.getElementById('chatWith').textContent = `ì±„íŒ… ìƒëŒ€: ${tName}`;

        const chatApp = document.getElementById('chatApp');
        const chatEmptyHint = document.getElementById('chatEmptyHint');

        chatApp.style.display = 'block';
        if (chatEmptyHint) {
            chatEmptyHint.style.display = 'none';
        }

        const sId = Number(document.getElementById('sId').value);
        if (!sId) {
            console.error("[ì˜¤ë¥˜] í•™ìƒ ID(sId)ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            alert("í•™ìƒì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
            return;
        }

        console.log("[ë””ë²„ê¹…] ë¶ˆëŸ¬ì˜¬ ì±„íŒ… ë‚´ì—­ | í•™ìƒ ID(sId):", sId, "| ì„ ìƒë‹˜ ID(tId):", tId);

        fetch(`/chat/api/history?sId=${sId}&tId=${tId}`)
            .then(response => response.json())
            .then(messages => {
                console.log("[ë””ë²„ê¹…] ë¶ˆëŸ¬ì˜¨ ë©”ì‹œì§€ ê°œìˆ˜:", messages.length);

                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';

                messages.forEach(message => {
                    let messageClass;
                    if (String(message.senderName).trim() === String(sId).trim()) {
                        messageClass = 'self';
                    } else if (String(message.receiverName).trim() === String(sId).trim()) {
                        messageClass = 'other';
                    } else {
                        console.warn("[ê²½ê³ ] í•„í„°ë§ë˜ì§€ ì•Šì€ ë©”ì‹œì§€:", message);
                        return;
                    }

                    showMessage(message, 'chatMessages', messageClass);
                });
            })
            .catch(error => console.error("ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:", error));
    }

    // ë©”ì‹œì§€ ì „ì†¡
    function sendPrivateMessage() {
        const messageInput = document.getElementById('messageInput');
        const messageContent = messageInput.value.trim();

        if (!messageContent || !currentPrivateChat) {
            alert("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        if (!stompClient || !stompClient.connected) {
            console.error("[ì˜¤ë¥˜] WebSocketì´ ì—°ê²°ë˜ì§€ ì•ŠìŒ! ì¬ì—°ê²° ì‹œë„ ì¤‘...");
            connect();
            setTimeout(() => sendPrivateMessage(), 500);
            return;
        }

        const chatMessage = {
            senderName: userData.username,
            receiverName: currentPrivateChat,
            message: messageContent,
            date: new Date().toISOString(),
            status: "MESSAGE"
        };

        console.log("[ë””ë²„ê¹…] ë©”ì‹œì§€ ì „ì†¡ ì‹œë„:", chatMessage);

        try {
            stompClient.send('/app/private-message', {}, JSON.stringify(chatMessage));
            console.log("[ì„±ê³µ] ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ:", chatMessage);

            showMessage(chatMessage, 'chatMessages', 'self');
            messageInput.value = '';
        } catch (error) {
            console.error("[ì˜¤ë¥˜] ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:", error);
        }
    }

    // ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ í•¸ë“¤ëŸ¬
    function onPrivateMessage(payload) {
        const message = JSON.parse(payload.body);

        const chatMessages = document.getElementById('chatMessages');
        const lastMessage = chatMessages.lastChild;

        if (lastMessage && lastMessage.textContent.includes(message.message)) {
            return;
        }

        const messageClass = message.senderName === userData.username ? 'self' : 'other';
        showMessage(message, 'chatMessages', messageClass);
    }

    // ë©”ì‹œì§€ í™”ë©´ì— í‘œì‹œ
    function showMessage(message, containerId, messageClass) {
        console.log("[ë””ë²„ê¹…] í™”ë©´ì— ì¶”ê°€í•  ë©”ì‹œì§€:", message,
            "| SN:", message.senderName,
            "| RN:", message.receiverName,
            "| ì ìš©í•  í´ë˜ìŠ¤:", messageClass);

        const chatMessages = document.getElementById(containerId);
        if (!chatMessages) {
            console.error("ì±„íŒ… ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!");
            return;
        }

        const messageElement = document.createElement('li');
        messageElement.className = messageClass;
        messageElement.textContent = `[${message.senderName}] ${message.message}`;

        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }


    // íƒ€ì´í•‘ ì‹œë„ì¤‘
    let typingTimeout;

    document.getElementById("messageInput").addEventListener("input", () => {
        sendTypingSignal();

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            sendStopTyping();
        }, 2500); // 2.5ì´ˆ ë™ì•ˆ ì¶”ê°€ ì…ë ¥ ì—†ìœ¼ë©´ STOP
    });

    function sendTypingSignal() {
        if (!currentPrivateChat) return;

        const typingMsg = {
            senderName: userData.username,
            receiverName: currentPrivateChat,
            status: "TYPING"
        };
        stompClient.send("/app/typing", {}, JSON.stringify(typingMsg));
    }

    function sendStopTyping() {
        if (!currentPrivateChat) return;

        const typingMsg = {
            senderName: userData.username,
            receiverName: currentPrivateChat,
            status: "STOP_TYPING"
        };
        stompClient.send("/app/typing", {}, JSON.stringify(typingMsg));
    }

    let typingTimer;


    function onTypingEvent(payload) {
        const msg = JSON.parse(payload.body);
        const statusLabel = document.getElementById("chatStatus");  // â† ì—¬ê¸°!

        if (!statusLabel) return;

        if (msg.status === "TYPING") {
            statusLabel.textContent = "ì…ë ¥ ì¤‘...";
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                statusLabel.textContent = "ëŒ€ê¸° ì¤‘";
            }, 2000);
        } else if (msg.status === "STOP_TYPING") {
            statusLabel.textContent = "ëŒ€ê¸° ì¤‘";
        }
    }


</script>

</body>
</html>
